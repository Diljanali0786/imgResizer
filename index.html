<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ImgResizer - Resize by KB</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #f8f9fa;
    }
    h1 {
      color: white;
      background-color: darkred;
      padding: 10px;
      border-radius: 8px;
    }
    #upload-section, #controls {
      margin: 15px 0;
    }
    input[type="number"], select {
      width: 100px;
      margin: 5px;
      padding: 5px;
    }
    #image-container {
      max-width: 100%;
      max-height: 400px;
      overflow: hidden;
      display: inline-block;
      border: 1px solid #ccc;
      margin-top: 15px;
    }
    #preview {
      max-width: 100%;
      max-height: 400px;
      display: none;
    }
    #download-btn {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #download-btn:active {
      background-color: #28a745;
    }
    #img-size {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ImgResizer - Resize by KB</h1>
  <div id="upload-section">
    <input type="file" id="upload" accept="image/*">
  </div>
  <div id="controls">
    <label>Width:</label>
    <input type="number" id="width" value="100">
    <label>Height:</label>
    <input type="number" id="height" value="120">
    <select id="unit">
      <option value="px">px</option>
      <option value="cm">cm</option>
    </select>
    <br>
    <label>Target Size (KB):</label>
    <input type="number" id="targetKB" value="50">
  </div>
  <button id="download-btn">Download Cropped Image</button>
  <div id="image-container">
    <img id="preview" />
  </div>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="img-size"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script>
    const upload = document.getElementById('upload');
    const preview = document.getElementById('preview');
    const widthInput = document.getElementById('width');
    const heightInput = document.getElementById('height');
    const unitSelect = document.getElementById('unit');
    const targetKBInput = document.getElementById('targetKB');
    const downloadBtn = document.getElementById('download-btn');
    const imgSizeDisplay = document.getElementById('img-size');

    let cropper;

    function cmToPx(cm) {
      return Math.round((cm / 2.54) * 96);
    }

    upload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        preview.src = event.target.result;
        preview.style.display = 'block';

        if (cropper) cropper.destroy();

        let width = parseInt(widthInput.value);
        let height = parseInt(heightInput.value);
        if (unitSelect.value === 'cm') {
          width = cmToPx(width);
          height = cmToPx(height);
        }

        cropper = new Cropper(preview, {
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 1,
          cropBoxResizable: false,
          cropBoxMovable: false,
          background: false,
          responsive: true,
          ready() {
            cropper.setCropBoxData({ width, height });
          }
        });
      };
      reader.readAsDataURL(file);
    });

    downloadBtn.addEventListener('click', () => {
      if (!cropper) return alert("Please upload an image first.");

      const croppedCanvas = cropper.getCroppedCanvas();
      const tempCanvas = document.createElement('canvas');
      const ctx = tempCanvas.getContext('2d');

      let width = parseInt(widthInput.value);
      let height = parseInt(heightInput.value);
      if (unitSelect.value === 'cm') {
        width = cmToPx(width);
        height = cmToPx(height);
      }

      tempCanvas.width = width;
      tempCanvas.height = height;
      ctx.drawImage(croppedCanvas, 0, 0, width, height);

      compressExactKB(tempCanvas, parseInt(targetKBInput.value));
    });

    function compressExactKB(canvas, targetKB) {
      let quality = 1.0;
      const targetBytes = targetKB * 1024;

      canvas.toBlob(async (blob) => {
        if (blob.size === targetBytes) {
          triggerDownload(blob);
        } else if (blob.size > targetBytes) {
          reduce(blob);
        } else {
          pad(blob);
        }
      }, 'image/jpeg', quality);

      function reduce(blob) {
        let q = 0.95;
        const tryReduce = () => {
          canvas.toBlob((b) => {
            if (b.size <= targetBytes || q < 0.1) {
              triggerDownload(b);
            } else {
              q -= 0.05;
              tryReduce();
            }
          }, 'image/jpeg', q);
        };
        tryReduce();
      }

      function pad(blob) {
        const padding = targetBytes - blob.size;
        const dummy = new Uint8Array(padding).fill(0);
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result;
          const combined = base64 + btoa(String.fromCharCode.apply(null, dummy));
          const byteString = atob(combined);
          const ab = new ArrayBuffer(byteString.length);
          const ia = new Uint8Array(ab);
          for (let i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
          }
          const paddedBlob = new Blob([ia], { type: 'image/jpeg' });
          triggerDownload(paddedBlob);
        };
        reader.readAsDataURL(blob);
      }

      function triggerDownload(blob) {
        const sizeKB = (blob.size / 1024).toFixed(2);
        imgSizeDisplay.textContent = `Final image size: ${sizeKB} KB`;
        const link = document.createElement('a');
        link.download = 'resized-image.jpg';
        link.href = URL.createObjectURL(blob);
        link.click();
      }
    }
  </script>
</body>
</html>
